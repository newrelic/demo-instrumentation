---

# This play require the following variable set
#   newrelic_personal_api_key: "<from user config newrelic credential>"
#   newrelic_account_id: the newrelic account id

# Additional optional fields:
#   newrelic_api_url: the URL for the newrelic REST API, default to main us URL
#   dashboard_name: the dashboard name, otherwise default to "Golden {{ deployment_name }}"

# Testing with EU
# - set_fact:
#     newrelic_api_url: "api.eu.newrelic.com"

- debug:
    msg: "Deploying dashboard for {{ deployment_name }} using REST v2 API"

- fail:
    msg: "A newrelic nrPersonalApiKey is required. Create this entry in your user config file"
  when: newrelic_personal_api_key is not defined

- fail:
    msg: "dashboard_template_url is required"
  when: dashboard_template_url is not defined

- name: Set default newrelic api url
  set_fact:
    newrelic_api_url: "api.newrelic.com"
  when: newrelic_api_url is undefined

- name: Ensure https api url
  set_fact:
    newrelic_api_url: "https://{{ newrelic_api_url }}"
  when: not newrelic_api_url | regex_search('^https', ignorecase=True)

- debug:
    msg: "Using newrelic_api_url:{{ newrelic_api_url }}"

- name: Set default dashboard name using deployment_name:{{ deployment_name }}
  set_fact:
    dashboard_name: "Golden {{ deployment_name }}"
  when: dashboard_name is undefined

- name: Get the dashboard json template
  uri:
    url: "{{ dashboard_template_url }}"
    return_content: yes
  register: dashboard_template_result

- name: Store dashboard json in file
  copy:
    dest: "{{ playbook_dir }}/dashboard.json"
    content: "{{ dashboard_template_result.json }}"

- name: Replace accountId 
  replace:
    path: "{{ playbook_dir }}/dashboard.json"
    regexp: '"accountId": 0'
    replace: '"accountId": {{ newrelic_account_id }}'

- name: Read the modified dashboard json
  set_fact:
    # The space after the quote is intentational and prevents ansible from evaluating it as json
    dashboard_template_json: "{{ lookup('file', playbook_dir + '/dashboard.json') | to_json }}"

- name: Create graphql query
  template:
    src: dashboard.graphql
    dest: "{{ playbook_dir }}/dashboard_query.gql"

- name: payload
  set_fact:
    payload: "{{ lookup('file', playbook_dir + '/dashboard_query.gql') }}"

- debug:
    msg: "payload: {{ payload }}"

- name: debug file
  copy:
    dest: "{{ playbook_dir }}/debug_payload.txt"
    content: "{{ payload }}"

- name: Create payload file
  template:
    src: gql_query.source.json
    dest: "{{ playbook_dir }}/gql_query.json"
  delegate_to: localhost  
    
- name: Create Workload
  shell: "curl -X POST '{{ newrelic_api_url }}/graphql' \
     -H 'Api-Key:{{ newrelic_personal_api_key }}' \
     -L -H 'Content-Type: application/json' \
     -d @{{ playbook_dir }}/gql_query.json"
  delegate_to: localhost

